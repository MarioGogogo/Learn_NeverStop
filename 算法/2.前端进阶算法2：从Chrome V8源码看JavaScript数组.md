# å‰ç«¯è¿›é˜¶ç®—æ³•2ï¼šä»Chrome V8æºç çœ‹JavaScriptæ•°ç»„ï¼ˆé™„èµ è…¾è®¯é¢è¯•é¢˜ï¼‰

### ç®€ä»‹

æ•°ç»„ã€é“¾è¡¨ã€æ ˆã€é˜Ÿåˆ—éƒ½æ˜¯çº¿æ€§è¡¨ï¼Œå®ƒè¡¨ç¤ºçš„ç»“æ„éƒ½æ˜¯ä¸€æ®µçº¿æ€§çš„ç»“æ„ï¼Œä¸ä¹‹å¯¹åº”çš„å°±æ˜¯éçº¿æ€§è¡¨ï¼Œä¾‹å¦‚æ ‘ã€å›¾ã€å †ç­‰ï¼Œå®ƒè¡¨ç¤ºçš„ç»“æ„éƒ½éçº¿æ€§ã€‚

æœ¬èŠ‚ä¸»è¦ä»‹ç» JavaScript æ•°ç»„ï¼Œåœ¨å¼€å§‹æœ¬ç« èŠ‚å‰ï¼Œæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š

æˆ‘ä»¬çŸ¥é“åœ¨ JavaScript ä¸­ï¼Œå¯ä»¥åœ¨æ•°ç»„ä¸­ä¿å­˜ä¸åŒç±»å‹å€¼ï¼Œå¹¶ä¸”æ•°ç»„å¯ä»¥åŠ¨æ€å¢é•¿ï¼Œä¸åƒå…¶å®ƒè¯­è¨€ï¼Œä¾‹å¦‚ Cï¼Œåˆ›å»ºçš„æ—¶å€™è¦å†³å®šæ•°ç»„çš„å¤§å°ï¼Œå¦‚æœæ•°ç»„æ»¡äº†ï¼Œå°±è¦é‡æ–°ç”³è¯·å†…å­˜ç©ºé—´ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå–ƒï¼Ÿ

æœ¬èŠ‚ä» Chrome v8 æºç è§’åº¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œåˆ†ä¸ºå››ä¸ªæ–¹é¢ï¼š

- æ•°ç»„åŸºç¡€å…¥é—¨
- JavaScript ä¸­ï¼Œæ•°ç»„ä¸ºä»€ä¹ˆå¯ä»¥ä¿å­˜ä¸åŒç±»å‹ï¼Ÿ
- JavaScript ä¸­ï¼Œæ•°ç»„æ˜¯å¦‚ä½•å­˜å‚¨çš„å–ƒï¼Ÿ
- JavaScript ä¸­ï¼Œæ•°ç»„çš„åŠ¨æ€æ‰©å®¹ä¸å‡å®¹ï¼ˆ `FastElements` ï¼‰

ä¸‹é¢è¿›å…¥æ­£é¢˜å§ï¼ï¼ˆæ–‡æœ«æœ‰æƒŠå–œï¼‰ğŸ˜Š

æƒ³è¦æ›´å¤šæ›´å¿«çš„å­¦ä¹ æœ¬ç³»åˆ—ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·ã€Œå‰ç«¯ç“¶å­å›ã€å’Œæˆ‘çš„ã€Œ[Githubï¼ˆç‚¹å‡»æŸ¥çœ‹ï¼‰](https://github.com/sisterAn/JavaScript-Algorithms)ã€

### ä¸€ã€æ•°ç»„ï¼ˆåŸºç¡€ï¼‰

ä¸€ç§æœ€åŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œæ¯ç§ç¼–ç¨‹è¯­è¨€éƒ½æœ‰ï¼Œå®ƒç¼–å·ä» 0 å¼€å§‹ï¼Œä»£è¡¨ä¸€ç»„è¿ç»­çš„å‚¨å­˜ç»“æ„ï¼Œç”¨æ¥å‚¨å­˜åŒä¸€ç§ç±»å‹çš„æ•°æ®ã€‚

```
let arr = [1, 2, 3]
```

å®ƒçš„è¿™ç§ç‰¹å®šçš„å­˜å‚¨ç»“æ„ï¼ˆè¿ç»­å­˜å‚¨ç©ºé—´å­˜å‚¨åŒä¸€ç±»å‹æ•°æ®ï¼‰å†³å®šäº†ï¼š

**ä¼˜ç‚¹**

- éšæœºè®¿é—®ï¼šå¯ä»¥é€šè¿‡ä¸‹æ ‡éšæœºè®¿é—®æ•°ç»„ä¸­çš„ä»»æ„ä½ç½®ä¸Šçš„æ•°æ®

**ç¼ºç‚¹**

- å¯¹æ•°æ®çš„åˆ é™¤å’Œæ’å…¥ä¸æ˜¯å¾ˆå‹å¥½

**æŸ¥æ‰¾ï¼š** æ ¹æ®ä¸‹æ ‡éšæœºè®¿é—®çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›

**æ’å…¥æˆ–åˆ é™¤ï¼š** æ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼›

åœ¨ JavaScript ä¸­çš„æ•°ç»„å‡ ä¹æ˜¯ä¸‡èƒ½çš„ï¼Œå®ƒä¸å…‰å¯ä»¥ä½œä¸ºä¸€ä¸ªæ™®é€šçš„æ•°ç»„ä½¿ç”¨ï¼Œå¯ä»¥ä½œä¸ºæ ˆæˆ–é˜Ÿåˆ—ä½¿ç”¨ã€‚

æ•°ç»„ï¼š

```
let array = [1, 2, 3]
```

æ ˆï¼š

```
let stack = [1, 2, 3]
// è¿›æ ˆ
stack.push(4)
// å‡ºæ ˆ
stcak.pop()
```

é˜Ÿåˆ—ï¼š

```
let queue = [1, 2, 3]
// è¿›é˜Ÿ
queue.push(4)
// å‡ºé˜Ÿ
queue.shift()
```

### äºŒã€JavaScript ä¸­ï¼Œæ•°ç»„å¯ä»¥ä¿å­˜ä¸åŒç±»å‹å€¼

çœ‹ä¸€ä¸‹ Chrome v8 æºç ï¼š

```
// The JSArray describes JavaScript Arrays
//  Such an array can be in one of two modes:
//    - fast, backing storage is a FixedArray and length <= elements.length();
//       Please note: push and pop can be used to grow and shrink the array.
//    - slow, backing storage is a HashTable with numbers as keys.
class JSArray: public JSObject {
 public:
  // [length]: The length property.
  DECL_ACCESSORS(length, Object)
    
  // ...
   
  // Number of element slots to pre-allocate for an empty array.
  static const int kPreallocatedArrayElements = 4;
};
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `JSArray` æ˜¯ç»§æ‰¿è‡ª `JSObject` çš„ï¼Œæ‰€ä»¥åœ¨ JavaScript ä¸­ï¼Œæ•°ç»„å¯ä»¥æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œå†…éƒ¨ä¹Ÿæ˜¯ä»¥ key-value å½¢å¼å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥ JavaScript ä¸­çš„æ•°ç»„å¯ä»¥å­˜æ”¾ä¸åŒç±»å‹çš„å€¼ã€‚

### ä¸‰ã€JavaScript ä¸­ï¼Œæ•°ç»„çš„å­˜å‚¨

```
// The JSArray describes JavaScript Arrays
//  Such an array can be in one of two modes:
//    - fast, backing storage is a FixedArray and length <= elements.length();
//       Please note: push and pop can be used to grow and shrink the array.
//    - slow, backing storage is a HashTable with numbers as keys.
class JSArray: public JSObject {
 public:
  // [length]: The length property.
  DECL_ACCESSORS(length, Object)
    
  // ...
   
  // Number of element slots to pre-allocate for an empty array.
  static const int kPreallocatedArrayElements = 4;
};
```

`JSArray` ç»§æ‰¿äº `JSObject` ï¼Œä»æ³¨é‡Šä¸Šçœ‹ï¼Œå®ƒæœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼š

- fastï¼šå­˜å‚¨ç»“æ„æ˜¯ `FixedArray` ï¼Œå¹¶ä¸”æ•°ç»„é•¿åº¦ `<= elements.length()` ï¼Œ`push` æˆ– `pop` æ—¶å¯èƒ½ä¼šä¼´éšç€åŠ¨æ€æ‰©å®¹æˆ–å‡å®¹
- slowï¼šå­˜å‚¨ç»“æ„æ˜¯ `HashTable`ï¼ˆå“ˆå¸Œè¡¨ï¼‰ï¼Œå¹¶ä¸”æ•°ç»„ä¸‹æ ‡ä½œä¸º `key`

`fast` æ¨¡å¼ä¸‹æ•°ç»„åœ¨æºç é‡Œé¢å« `FastElements` ï¼Œè€Œ `slow` æ¨¡å¼ä¸‹çš„å«åš `SlowElements` ã€‚

#### 1. å¿«æ•°ç»„ï¼ˆFastElementsï¼‰

`FixedArray` æ˜¯ V8 å®ç°çš„ä¸€ä¸ªç±»ä¼¼äºæ•°ç»„çš„ç±»ï¼Œå®ƒè¡¨ç¤ºä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨ç´¢å¼•ç›´æ¥å®šä½ã€‚æ–°åˆ›å»ºçš„ç©ºæ•°ç»„é»˜è®¤å°±æ˜¯å¿«æ•°ç»„ã€‚å½“æ•°ç»„æ»¡ï¼ˆæ•°ç»„çš„é•¿åº¦è¾¾åˆ°æ•°ç»„åœ¨å†…å­˜ä¸­ç”³è¯·çš„å†…å­˜å®¹é‡æœ€å¤§å€¼ï¼‰çš„æ—¶å€™ï¼Œç»§ç»­ `push` æ—¶ï¼Œ `JSArray` ä¼šè¿›è¡ŒåŠ¨æ€çš„æ‰©å®¹ï¼Œä»¥å­˜å‚¨æ›´å¤šçš„å…ƒç´ ã€‚

#### 2. æ…¢æ•°ç»„ï¼ˆSlowElementsï¼‰

æ…¢æ•°ç»„ä»¥å“ˆå¸Œè¡¨çš„å½¢å¼å­˜å‚¨åœ¨å†…å­˜ç©ºé—´é‡Œï¼Œå®ƒä¸éœ€è¦å¼€è¾Ÿè¿ç»­çš„å­˜å‚¨ç©ºé—´ï¼Œä½†éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸å¿«æ•°ç»„ç›¸æ¯”ï¼Œæ€§èƒ½ç›¸å¯¹è¾ƒå·®ã€‚

```
// src/objects/dictionary.h
class EXPORT_TEMPLATE_DECLARE(V8_EXPORT_PRIVATE) Dictionary
    : public HashTable<Derived, Shape> {
  using DerivedHashTable = HashTable<Derived, Shape>;

 public:
  using Key = typename Shape::Key;
  // Returns the value at entry.
  inline Object ValueAt(InternalIndex entry);
  inline Object ValueAt(const Isolate* isolate, InternalIndex entry);
  
  // ...
};
```

ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„å†…éƒ¨å°±æ˜¯ä¸€ä¸ª HashTableã€‚

#### 3. ä»€ä¹ˆæ—¶å€™ä¼šä» fast è½¬å˜ä¸º slow å–ƒï¼Ÿ

ä» Chrome V8 æºç ä¸Šçœ‹ï¼Œ

```
// src/objects/js-objects.h
static const uint32_t kMaxGap = 1024;

// src/objects/dictionary.h
// JSObjects prefer dictionary elements if the dictionary saves this much
// memory compared to a fast elements backing store.
static const uint32_t kPreferFastElementsSizeFactor = 3;

// src/objects/js-objects-inl.h
// If the fast-case backing storage takes up much more memory than a dictionary
// backing storage would, the object should have slow elements.
// static
static inline bool ShouldConvertToSlowElements(uint32_t used_elements,
                                               uint32_t new_capacity) {
  uint32_t size_threshold = NumberDictionary::kPreferFastElementsSizeFactor *
                            NumberDictionary::ComputeCapacity(used_elements) *
                            NumberDictionary::kEntrySize;
  // å¿«æ•°ç»„æ–°å®¹é‡æ˜¯æ‰©å®¹åçš„å®¹é‡3å€ä¹‹å¤šæ—¶ï¼Œä¹Ÿä¼šè¢«è½¬æˆæ…¢æ•°ç»„
  return size_threshold <= new_capacity;
}

static inline bool ShouldConvertToSlowElements(JSObject object,
                                               uint32_t capacity,
                                               uint32_t index,
                                               uint32_t* new_capacity) {
  STATIC_ASSERT(JSObject::kMaxUncheckedOldFastElementsLength <=
                JSObject::kMaxUncheckedFastElementsLength);
  if (index < capacity) {
    *new_capacity = capacity;
    return false;
  }
  // å½“åŠ å…¥çš„ç´¢å¼•å€¼ï¼ˆä¾‹å¦‚ä¾‹3ä¸­çš„2000ï¼‰æ¯”å½“å‰å®¹é‡capacity å¤§äºç­‰äº 1024æ—¶ï¼Œ
  // è¿”å›trueï¼Œè½¬ä¸ºæ…¢æ•°ç»„
  if (index - capacity >= JSObject::kMaxGap) return true;
  *new_capacity = JSObject::NewElementsCapacity(index + 1);
  DCHECK_LT(index, *new_capacity);
  // TODO(ulan): Check if it works with young large objects.
  if (*new_capacity <= JSObject::kMaxUncheckedOldFastElementsLength ||
      (*new_capacity <= JSObject::kMaxUncheckedFastElementsLength &&
       ObjectInYoungGeneration(object))) {
    return false;
  }
  return ShouldConvertToSlowElements(object.GetFastElementsUsage(),
                                     *new_capacity);
}
```

æ‰€ä»¥ï¼Œå½“å¤„äºä»¥ä¸‹æƒ…å†µæ—¶ï¼Œå¿«æ•°ç»„ä¼šè¢«è½¬å˜ä¸ºæ…¢æ•°ç»„ï¼š

- å½“åŠ å…¥çš„ç´¢å¼•å€¼ index æ¯”å½“å‰å®¹é‡ capacity å·®å€¼å¤§äºç­‰äº 1024 æ—¶ï¼ˆindex - capacity >= 1024ï¼‰
- å¿«æ•°ç»„æ–°å®¹é‡æ˜¯æ‰©å®¹åçš„å®¹é‡ 3 å€ä¹‹å¤šæ—¶

ä¾‹å¦‚ï¼šå‘å¿«æ•°ç»„é‡Œå¢åŠ ä¸€ä¸ªå¤§ç´¢å¼•åŒç±»å‹å€¼

```
var arr = [1, 2, 3]
arr[2000] = 10;
```

å½“å¾€ `arr` å¢åŠ ä¸€ä¸ª `2000` çš„ç´¢å¼•æ—¶ï¼Œ`arr` è¢«è½¬æˆæ…¢æ•°ç»„ã€‚èŠ‚çœäº†å¤§é‡çš„å†…å­˜ç©ºé—´ï¼ˆä»ç´¢å¼•ä¸º 2 åˆ°ç´¢å¼•ä¸º 2000ï¼‰ã€‚

#### 4. ä»€ä¹ˆæ—¶å€™ä¼šä» slow è½¬å˜ä¸º fast å–ƒï¼Ÿ

æˆ‘ä»¬å·²ç»çŸ¥é“åœ¨ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°ç”±å¿«å˜æ…¢ï¼Œé‚£ç”±æ…¢å˜å¿«å°±å¾ˆç®€å•äº†

```
static bool ShouldConvertToFastElements(JSObject object,
                                        NumberDictionary dictionary,
                                        uint32_t index,
                                        uint32_t* new_capacity) {
  // If properties with non-standard attributes or accessors were added, we
  // cannot go back to fast elements.
  if (dictionary.requires_slow_elements()) return false;
  // Adding a property with this index will require slow elements.
  if (index >= static_cast<uint32_t>(Smi::kMaxValue)) return false;
  if (object.IsJSArray()) {
    Object length = JSArray::cast(object).length();
    if (!length.IsSmi()) return false;
    *new_capacity = static_cast<uint32_t>(Smi::ToInt(length));
  } else if (object.IsJSArgumentsObject()) {
    return false;
  } else {
    *new_capacity = dictionary.max_number_key() + 1;
  }
  *new_capacity = Max(index + 1, *new_capacity);
  uint32_t dictionary_size = static_cast<uint32_t>(dictionary.Capacity()) *
                             NumberDictionary::kEntrySize;
  // Turn fast if the dictionary only saves 50% space.
  return 2 * dictionary_size >= *new_capacity;
}
```

å½“æ…¢æ•°ç»„çš„å…ƒç´ å¯å­˜æ”¾åœ¨å¿«æ•°ç»„ä¸­ä¸”é•¿åº¦åœ¨ smi ä¹‹é—´ä¸”ä»…èŠ‚çœäº†50%çš„ç©ºé—´ï¼Œåˆ™ä¼šè½¬å˜ä¸ºå¿«æ•°ç»„

### å››ã€JavaScript ä¸­ï¼Œæ•°ç»„çš„åŠ¨æ€æ‰©å®¹ä¸å‡å®¹ï¼ˆFastElementsï¼‰

é»˜è®¤ç©ºæ•°ç»„åˆå§‹åŒ–å¤§å°ä¸º `4` :

```
// Number of element slots to pre-allocate for an empty array.
static const int kPreallocatedArrayElements = 4;
```

åœ¨ JavaScript ä¸­ï¼Œå½“æ•°ç»„æ‰§è¡Œ `push` æ“ä½œæ—¶ï¼Œä¸€æ—¦å‘ç°æ•°ç»„å†…å­˜ä¸è¶³ï¼Œå°†è¿›è¡Œæ‰©å®¹ã€‚

åœ¨ Chrome æºç ä¸­ï¼Œ `push` çš„æ“ä½œæ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œåœ¨ c++ é‡ŒåµŒå…¥çš„æ±‡ç¼–ï¼Œä»¥æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œå¹¶ä¸”åœ¨æ±‡ç¼–çš„åŸºç¡€ä¸Šç”¨ c++ å°è£…äº†ä¸€å±‚ï¼Œåœ¨ç¼–è¯‘æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå°†è¿™äº› c++ ä»£ç è½¬æˆæ±‡ç¼–ä»£ç ã€‚

è®¡ç®—æ–°å®¹é‡çš„å‡½æ•°ï¼š

```
// js-objects.h
static const uint32_t kMinAddedElementsCapacity = 16;

// code-stub-assembler.cc
Node* CodeStubAssembler::CalculateNewElementsCapacity(Node* old_capacity,
                                                      ParameterMode mode) {
  CSA_SLOW_ASSERT(this, MatchesParameterMode(old_capacity, mode));
  Node* half_old_capacity = WordOrSmiShr(old_capacity, 1, mode);
  Node* new_capacity = IntPtrOrSmiAdd(half_old_capacity, old_capacity, mode);
  Node* padding =
      IntPtrOrSmiConstant(JSObject::kMinAddedElementsCapacity, mode);
  return IntPtrOrSmiAdd(new_capacity, padding, mode);
}
```

æ‰€ä»¥æ‰©å®¹åæ–°å®¹é‡è®¡å…¬å¼ä¸ºï¼š

> new_capacity = old_capacity /2 + old_capacity + 16

å³è€çš„å®¹é‡çš„ 1.5 å€åŠ ä¸Š 16 ã€‚åˆå§‹åŒ–ä¸º 4 ä¸ªï¼Œå½“ `push` ç¬¬ 5 ä¸ªçš„æ—¶å€™ï¼Œå®¹é‡å°†ä¼šå˜æˆï¼š

> new_capacity = 4 / 2 + 4 + 16 = 22

æ¥ç€ç”³è¯·ä¸€å—è¿™ä¹ˆå¤§çš„å†…å­˜ï¼ŒæŠŠè€çš„æ•°æ®æ‹·è¿‡å»ï¼ŒæŠŠæ–°å…ƒç´ æ”¾åœ¨å½“å‰ length ä½ç½®ï¼Œç„¶åå°†æ•°ç»„çš„ length + 1ï¼Œå¹¶è¿”å› lengthã€‚

æ‰€ä»¥ï¼Œæ‰©å®¹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

- `push` æ“ä½œæ—¶ï¼Œå‘ç°æ•°ç»„å†…å­˜ä¸è¶³
- ç”³è¯· new_capacity = old_capacity /2 + old_capacity + 16 é‚£ä¹ˆé•¿åº¦çš„å†…å­˜ç©ºé—´
- å°†æ•°ç»„æ‹·è´åˆ°æ–°å†…å­˜ä¸­
- æŠŠæ–°å…ƒç´ æ”¾åœ¨å½“å‰ length ä½ç½®
- æ•°ç»„çš„ length + 1
- è¿”å› length

æ•´ä¸ªè¿‡ç¨‹ï¼Œç”¨æˆ·æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œä¸åƒ Cï¼Œéœ€ç”¨ç”¨æˆ·æ‰‹åŠ¨ç”³è¯·å†…å­˜ç©ºé—´ã€‚

å½“æ•°ç»„æ‰§è¡Œ `pop` æ“ä½œæ—¶ï¼Œä¼šåˆ¤æ–­ `pop` åæ•°ç»„çš„å®¹é‡ï¼Œæ˜¯å¦éœ€è¦è¿›è¡Œå‡å®¹ã€‚

ä¸åŒäºæ•°ç»„çš„ `push` ä½¿ç”¨æ±‡ç¼–å®ç°çš„ï¼Œ `pop` ä½¿ç”¨ c++ å®ç°çš„ã€‚

åˆ¤æ–­æ˜¯å¦è¿›è¡Œå‡å®¹ï¼š

```
if (2 * length <= capacity) {
  // If more than half the elements won't be used, trim the array.
  isolate->heap()->RightTrimFixedArray(*backing_store, capacity - length);
} else {
  // Otherwise, fill the unused tail with holes.
  BackingStore::cast(*backing_store)->FillWithHoles(length, old_length);
}
```

æ‰€ä»¥ï¼Œå½“æ•°ç»„ `pop` åï¼Œå¦‚æœæ•°ç»„å®¹é‡å¤§äºç­‰äº length çš„ 2 å€ï¼Œåˆ™è¿›è¡Œå®¹é‡è°ƒæ•´ï¼Œä½¿ç”¨ `RightTrimFixedArray` å‡½æ•°ï¼Œè®¡ç®—å‡ºéœ€è¦é‡Šæ”¾çš„ç©ºé—´å¤§å°ï¼Œåšå¥½æ ‡è®°ï¼Œç­‰å¾… GC å›æ”¶ï¼›å¦‚æœæ•°ç»„å®¹é‡å°äº length çš„ 2 å€ï¼Œåˆ™ç”¨ holes å¯¹è±¡å¡«å……ã€‚

æ‰€ä»¥ï¼Œå‡å®¹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

- `pop` æ“ä½œæ—¶ï¼Œè·å–æ•°ç»„ `length`
- è·å– `length - 1` ä¸Šçš„å…ƒç´ ï¼ˆè¦åˆ é™¤çš„å…ƒç´ ï¼‰
- æ•°ç»„ `length - 1`
- åˆ¤æ–­æ•°ç»„çš„æ€»å®¹é‡æ˜¯å¦å¤§äºç­‰äº length - 1 çš„ 2 å€
- æ˜¯çš„è¯ï¼Œä½¿ç”¨ `RightTrimFixedArray` å‡½æ•°ï¼Œè®¡ç®—å‡ºéœ€è¦é‡Šæ”¾çš„ç©ºé—´å¤§å°ï¼Œå¹¶åšå¥½æ ‡è®°ï¼Œç­‰å¾… `GC` å›æ”¶
- ä¸æ˜¯çš„è¯ï¼Œç”¨ `holes` å¯¹è±¡å¡«å……
- è¿”å›è¦åˆ é™¤çš„å…ƒç´ 

### äº”ã€è§£ç­”å¼€ç¯‡é—®é¢˜

JavaScript ä¸­ï¼Œ `JSArray` ç»§æ‰¿è‡ª `JSObject` ï¼Œæˆ–è€…è¯´å®ƒå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œå†…éƒ¨æ˜¯ä»¥ key-value å½¢å¼å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥ JavaScript ä¸­çš„æ•°ç»„å¯ä»¥å­˜æ”¾ä¸åŒç±»å‹çš„å€¼ã€‚å®ƒæœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼Œå¿«æ•°ç»„ä¸æ…¢æ•°ç»„ï¼Œåˆå§‹åŒ–ç©ºæ•°ç»„æ—¶ï¼Œä½¿ç”¨å¿«æ•°ç»„ï¼Œå¿«æ•°ç»„ä½¿ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå½“æ•°ç»„é•¿åº¦è¾¾åˆ°æœ€å¤§æ—¶ï¼Œ`JSArray` ä¼šè¿›è¡ŒåŠ¨æ€çš„æ‰©å®¹ï¼Œä»¥å­˜å‚¨æ›´å¤šçš„å…ƒç´ ï¼Œç›¸å¯¹æ…¢æ•°ç»„ï¼Œæ€§èƒ½è¦å¥½å¾—å¤šã€‚å½“æ•°ç»„ä¸­ `hole` å¤ªå¤šæ—¶ï¼Œä¼šè½¬å˜æˆæ…¢æ•°ç»„ï¼Œå³ä»¥å“ˆå¸Œè¡¨çš„æ–¹å¼ï¼ˆ key-value çš„å½¢å¼ï¼‰å­˜å‚¨æ•°æ®ï¼Œä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚

### å…­ã€æœ€åé™„èµ ä¸€é“å‰ç«¯é¢è¯•é¢˜ï¼ˆè…¾è®¯ï¼‰ï¼šæ•°ç»„æ‰å¹³åŒ–ã€å»é‡ã€æ’åº

å…³äº `Array` çš„å±æ€§ã€æ–¹æ³•è¿™é‡Œä¸å†åšä»‹ç»ï¼Œè¯¦çœ‹ [MDN Array](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array) ã€‚

é¢è¯•é¢˜ï¼š

> å·²çŸ¥å¦‚ä¸‹æ•°ç»„ï¼švar arr = [ [1, 2, 2], [3, 4, 5, 5], [6, 7, 8, 9, [11, 12, [12, 13, [14] ] ] ], 10];
>
> ç¼–å†™ä¸€ä¸ªç¨‹åºå°†æ•°ç»„æ‰å¹³åŒ–å»å¹¶é™¤å…¶ä¸­é‡å¤éƒ¨åˆ†æ•°æ®ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå‡åºä¸”ä¸é‡å¤çš„æ•°ç»„

ç­”æ¡ˆï¼š

```
var arr = [ [1, 2, 2], [3, 4, 5, 5], [6, 7, 8, 9, [11, 12, [12, 13, [14] ] ] ], 10]
// æ‰å¹³åŒ–
let flatArr = arr.flat(4)
// å»é‡
let disArr = Array.from(new Set(flatArr))
// æ’åº
let result = disArr.sort(function(a, b) {
    return a-b
})
console.log(result)
// [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
```

å…³äº Set è¯·æŸ¥é˜… [Setã€WeakSetã€MapåŠWeakMap](https://github.com/LuNaHaiJiao/blog/issues/24)

å‚è€ƒé“¾æ¥ï¼š

[æ¢ç©¶JS V8å¼•æ“ä¸‹çš„â€œæ•°ç»„â€åº•å±‚å®ç°](https://juejin.im/post/5d80919b51882538036fc87d)

[ä»Chromeæºç çœ‹JS Arrayçš„å®ç°](https://zhuanlan.zhihu.com/p/26388217)

