# å‰ç«¯è¿›é˜¶ç®—æ³•3ï¼šä»æµè§ˆå™¨ç¼“å­˜æ·˜æ±°ç­–ç•¥å’ŒVueçš„keep-aliveå­¦ä¹ LRUç®—æ³•

### å¼•è¨€

è¿™ä¸ªæ ‡é¢˜å·²ç»å¾ˆæ˜æ˜¾çš„å‘Šè¯‰æˆ‘ä»¬ï¼šå‰ç«¯éœ€è¦äº†è§£ LRU ç®—æ³•ï¼

è¿™ä¹Ÿæ˜¯å‰ç«¯æŠ€èƒ½çš„äº®ç‚¹ï¼Œå½“é¢è¯•å®˜åœ¨é—®åˆ°ä½ å‰ç«¯å¼€å‘ä¸­é‡åˆ°è¿‡å“ªäº›ç®—æ³•ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™éƒ¨åˆ†ä¸¢è¿‡å»ï¼

æœ¬èŠ‚æŒ‰ä»¥ä¸‹æ­¥éª¤åˆ‡å…¥ï¼š

- ç”±æµè§ˆå™¨ç¼“å­˜ç­–ç•¥å¼•å‡º LRU ç®—æ³•åŸç†
- ç„¶åèµ°è¿› `vue` ä¸­ `keep-alive` çš„åº”ç”¨
- æ¥ç€ï¼Œé€è¿‡ `vue` ä¸­ `keep-alive` æºç çœ‹ `LRU` ç®—æ³•çš„å®ç°
- æœ€åï¼Œæ¥ä¸€é“ leetcode é¢˜ç›®ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª LRU ç®—æ³•

æŒ‰è¿™ä¸ªæ­¥éª¤æ¥ï¼Œå®Œå…¨æŒæ¡ LRU ç®—æ³•ï¼Œç‚¹äº®å‰ç«¯æŠ€èƒ½ï¼Œä¸‹é¢å°±å¼€å§‹å§ğŸ‘‡

### ä¸€ã€LRU ç¼“å­˜æ·˜æ±°ç­–ç•¥

**ç¼“å­˜**åœ¨è®¡ç®—æœºç½‘ç»œä¸Šéšå¤„å¯è§ï¼Œä¾‹å¦‚ï¼šå½“æˆ‘ä»¬é¦–æ¬¡è®¿é—®ä¸€ä¸ªç½‘é¡µæ—¶ï¼Œæ‰“å¼€å¾ˆæ…¢ï¼Œä½†å½“æˆ‘ä»¬å†æ¬¡æ‰“å¼€è¿™ä¸ªç½‘é¡µæ—¶ï¼Œæ‰“å¼€å°±å¾ˆå¿«ã€‚

è¿™å°±æ¶‰åŠç¼“å­˜åœ¨æµè§ˆå™¨ä¸Šçš„åº”ç”¨ï¼š**æµè§ˆå™¨ç¼“å­˜**ã€‚å½“æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªç½‘é¡µæ—¶ï¼Œä¾‹å¦‚ `https://github.com/sisterAn/JavaScript-Algorithms` ï¼Œå®ƒä¼šåœ¨å‘èµ·çœŸæ­£çš„ç½‘ç»œè¯·æ±‚å‰ï¼ŒæŸ¥è¯¢æµè§ˆå™¨ç¼“å­˜ï¼Œçœ‹æ˜¯å¦æœ‰è¦è¯·æ±‚çš„æ–‡ä»¶ï¼Œå¦‚æœæœ‰ï¼Œæµè§ˆå™¨å°†ä¼šæ‹¦æˆªè¯·æ±‚ï¼Œè¿”å›ç¼“å­˜æ–‡ä»¶ï¼Œå¹¶ç›´æ¥ç»“æŸè¯·æ±‚ï¼Œä¸ä¼šå†å»æœåŠ¡å™¨ä¸Šä¸‹è½½ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‰ä¼šå»æœåŠ¡å™¨è¯·æ±‚ã€‚

å…¶å®ï¼Œæµè§ˆå™¨ä¸­çš„ç¼“å­˜æ˜¯ä¸€ç§åœ¨æœ¬åœ°ä¿å­˜èµ„æºå‰¯æœ¬ï¼Œå®ƒçš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå½“æˆ‘ä»¬è¯·æ±‚æ•°è¿‡å¤šæ—¶ï¼Œç¼“å­˜ç©ºé—´ä¼šè¢«ç”¨æ»¡ï¼Œæ­¤æ—¶ï¼Œç»§ç»­è¿›è¡Œç½‘ç»œè¯·æ±‚å°±éœ€è¦ç¡®å®šç¼“å­˜ä¸­å“ªäº›æ•°æ®è¢«ä¿ç•™ï¼Œå“ªäº›æ•°æ®è¢«ç§»é™¤ï¼Œè¿™å°±æ˜¯**æµè§ˆå™¨ç¼“å­˜æ·˜æ±°ç­–ç•¥**ï¼Œæœ€å¸¸è§çš„æ·˜æ±°ç­–ç•¥æœ‰ FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ã€LFUï¼ˆæœ€å°‘ä½¿ç”¨ï¼‰ã€LRUï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ã€‚

LRU ï¼ˆ `Least Recently Used` ï¼š==æœ€è¿‘æœ€å°‘ä½¿ç”¨== ï¼‰ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼Œæ•…åæ€ä¹‰ï¼Œå°±æ˜¯æ ¹æ®æ•°æ®çš„å†å²è®¿é—®è®°å½•æ¥è¿›è¡Œæ·˜æ±°æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ **å¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜** ï¼Œä¼˜å…ˆæ·˜æ±°æœ€è¿‘æ²¡æœ‰è¢«è®¿é—®åˆ°çš„æ•°æ®ã€‚

ç”»ä¸ªå›¾å¸®åŠ©æˆ‘ä»¬ç†è§£ï¼š

[![img](/Users/lovewcc/Documents/07_å‰ç«¯å­¦ä¹ /ç®—æ³•/687474703a2f2f7265736f757263652e6d757969792e636e2f696d6167652f32303230303430363230353234372e706e67.png)](https://camo.githubusercontent.com/a06af57cca996cf2f3a7b80f1619ed3842c119fd/687474703a2f2f7265736f757263652e6d757969792e636e2f696d6167652f32303230303430363230353234372e706e67)

### äºŒã€LRU åœ¨ keep-alive (Vue) ä¸Šçš„å®ç°

#### 1. keep-alive

keep-alive åœ¨ vue ä¸­ç”¨äºå®ç°ç»„ä»¶çš„ç¼“å­˜ï¼Œå½“ç»„ä»¶åˆ‡æ¢æ—¶ä¸ä¼šå¯¹å½“å‰ç»„ä»¶è¿›è¡Œå¸è½½ã€‚

```
<!-- åŸºæœ¬ -->
<keep-alive>
  <component :is="view"></component>
</keep-alive>
```

æœ€å¸¸ç”¨çš„ä¸¤ä¸ªå±æ€§ï¼š`include` ã€ `exculde` ï¼Œç”¨äºç»„ä»¶è¿›è¡Œæœ‰æ¡ä»¶çš„ç¼“å­˜ï¼Œå¯ä»¥ç”¨é€—å·åˆ†éš”å­—ç¬¦ä¸²ã€æ­£åˆ™è¡¨è¾¾å¼æˆ–ä¸€ä¸ªæ•°ç»„æ¥è¡¨ç¤ºã€‚

åœ¨ 2.5.0 ç‰ˆæœ¬ä¸­ï¼Œ`keep-alive` æ–°å¢äº† `max` å±æ€§ï¼Œç”¨äºæœ€å¤šå¯ä»¥ç¼“å­˜å¤šå°‘ç»„ä»¶å®ä¾‹ï¼Œä¸€æ—¦è¿™ä¸ªæ•°å­—è¾¾åˆ°äº†ï¼Œåœ¨æ–°å®ä¾‹è¢«åˆ›å»ºä¹‹å‰ï¼Œå·²ç¼“å­˜ç»„ä»¶ä¸­æœ€ä¹…æ²¡æœ‰è¢«è®¿é—®çš„å®ä¾‹ä¼šè¢«é”€æ¯æ‰ï¼Œ**çœ‹ï¼Œè¿™é‡Œå°±åº”ç”¨äº† LRU ç®—æ³•**ã€‚å³åœ¨ `keep-alive` ä¸­ç¼“å­˜è¾¾åˆ° `max`ï¼Œæ–°å¢ç¼“å­˜å®ä¾‹ä¼šä¼˜å…ˆæ·˜æ±°æœ€è¿‘æ²¡æœ‰è¢«è®¿é—®åˆ°çš„å®ä¾‹ğŸ‰ğŸ‰ğŸ‰

ä¸‹é¢æˆ‘ä»¬é€è¿‡ vue æºç çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ğŸ‘‡

### 2. ä» vue æºç çœ‹ keep-alive çš„å®ç°

```js
export default {
  name: "keep-alive",
  // æŠ½è±¡ç»„ä»¶å±æ€§ ,å®ƒåœ¨ç»„ä»¶å®ä¾‹å»ºç«‹çˆ¶å­å…³ç³»çš„æ—¶å€™ä¼šè¢«å¿½ç•¥,å‘ç”Ÿåœ¨ initLifecycle çš„è¿‡ç¨‹ä¸­
  abstract: true, 
  props: {
    // è¢«ç¼“å­˜ç»„ä»¶
    include: patternTypes, 
    // ä¸è¢«ç¼“å­˜ç»„ä»¶
    exclude: patternTypes,
    // æŒ‡å®šç¼“å­˜å¤§å°
    max: [String, Number] 
  },
  created() {
    // åˆå§‹åŒ–ç”¨äºå­˜å‚¨ç¼“å­˜çš„ cache å¯¹è±¡
    this.cache = Object.create(null);
    // åˆå§‹åŒ–ç”¨äºå­˜å‚¨VNode keyå€¼çš„ keys æ•°ç»„
    this.keys = []; 
  },
  destroyed() {
    for (const key in this.cache) {
      // åˆ é™¤æ‰€æœ‰ç¼“å­˜
      pruneCacheEntry(this.cache, key, this.keys);
    }
  },
  mounted() {
    // ç›‘å¬ç¼“å­˜ï¼ˆincludeï¼‰/ä¸ç¼“å­˜ï¼ˆexcludeï¼‰ç»„ä»¶çš„å˜åŒ–
    // åœ¨å˜åŒ–æ—¶ï¼Œé‡æ–°è°ƒæ•´ cache
    // pruneCacheï¼šéå† cacheï¼Œå¦‚æœç¼“å­˜çš„èŠ‚ç‚¹åç§°ä¸ä¼ å…¥çš„è§„åˆ™æ²¡æœ‰åŒ¹é…ä¸Šçš„è¯ï¼Œå°±æŠŠè¿™ä¸ªèŠ‚ç‚¹ä»ç¼“å­˜ä¸­ç§»é™¤
    this.$watch("include", val => {
      pruneCache(this, name => matches(val, name));
    });
    this.$watch("exclude", val => {
      pruneCache(this, name => !matches(val, name));
    });
  },
  render() {
    // è·å–ç¬¬ä¸€ä¸ªå­å…ƒç´ çš„ vnode
    const slot = this.$slots.default;
    const vnode: VNode = getFirstComponentChild(slot);
    const componentOptions: ?VNodeComponentOptions =
      vnode && vnode.componentOptions;
    if (componentOptions) {
      // name ä¸åœ¨ inlcude ä¸­æˆ–è€…åœ¨ exlude ä¸­åˆ™ç›´æ¥è¿”å› vnodeï¼Œå¦åˆ™ç»§ç»­è¿›è¡Œä¸‹ä¸€æ­¥
      // check pattern
      const name: ?string = getComponentName(componentOptions);
      const { include, exclude } = this;
      if (
        // not included
        (include && (!name || !matches(include, name))) ||
        // excluded
        (exclude && name && matches(exclude, name))
      ) {
        return vnode;
      }
      
      const { cache, keys } = this;
      // è·å–é”®ï¼Œä¼˜å…ˆè·å–ç»„ä»¶çš„ name å­—æ®µï¼Œå¦åˆ™æ˜¯ç»„ä»¶çš„ tag
      const key: ?string =
        vnode.key == null
          ? // same constructor may get registered as different local components
            // so cid alone is not enough (#3269)
            componentOptions.Ctor.cid +
            (componentOptions.tag ? `::${componentOptions.tag}` : "")
          : vnode.key;
        
      // --------------------------------------------------
      // ä¸‹é¢å°±æ˜¯ LRU ç®—æ³•äº†ï¼Œ
      // å¦‚æœåœ¨ç¼“å­˜é‡Œæœ‰åˆ™è°ƒæ•´ï¼Œ
      // æ²¡æœ‰åˆ™æ”¾å…¥ï¼ˆé•¿åº¦è¶…è¿‡ maxï¼Œåˆ™æ·˜æ±°æœ€è¿‘æ²¡æœ‰è®¿é—®çš„ï¼‰
      // --------------------------------------------------
      // å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ä»ç¼“å­˜ä¸­è·å– vnode çš„ç»„ä»¶å®ä¾‹ï¼Œå¹¶ä¸”è°ƒæ•´ key çš„é¡ºåºæ”¾å…¥ keys æ•°ç»„çš„æœ«å°¾
      if (cache[key]) {
        vnode.componentInstance = cache[key].componentInstance;
        // make current key freshest
        remove(keys, key);
        keys.push(key);
      }
      // å¦‚æœæ²¡æœ‰å‘½ä¸­ç¼“å­˜,å°±æŠŠ vnode æ”¾è¿›ç¼“å­˜
      else {
        cache[key] = vnode;
        keys.push(key);
        // prune oldest entry
        // å¦‚æœé…ç½®äº† max å¹¶ä¸”ç¼“å­˜çš„é•¿åº¦è¶…è¿‡äº† this.maxï¼Œè¿˜è¦ä»ç¼“å­˜ä¸­åˆ é™¤ç¬¬ä¸€ä¸ª
        if (this.max && keys.length > parseInt(this.max)) {
          pruneCacheEntry(cache, keys[0], keys, this._vnode);
        }
      }
      
      // keepAliveæ ‡è®°ä½
      vnode.data.keepAlive = true;
    }
    return vnode || (slot && slot[0]);
  }
};

// ç§»é™¤ key ç¼“å­˜
function pruneCacheEntry (
  cache: VNodeCache,
  key: string,
  keys: Array<string>,
  current?: VNode
) {
  const cached = cache[key]
  if (cached && (!current || cached.tag !== current.tag)) {
    cached.componentInstance.$destroy()
  }
  cache[key] = null
  remove(keys, key)
}

// remove æ–¹æ³•ï¼ˆshared/util.jsï¼‰
/**
 * Remove an item from an array.
 */
export function remove (arr: Array<any>, item: any): Array<any> | void {
  if (arr.length) {
    const index = arr.indexOf(item)
    if (index > -1) {
      return arr.splice(index, 1)
    }
  }
}
```

[keep-aliveæºç è·¯å¾„](https://github.com/vuejs/vue/blob/dev/src/core/components/keep-alive.js)

åœ¨ `keep-alive` ç¼“å­˜è¶…è¿‡ `max` æ—¶ï¼Œä½¿ç”¨çš„ç¼“å­˜æ·˜æ±°ç®—æ³•å°±æ˜¯ LRU ç®—æ³•ï¼Œå®ƒåœ¨å®ç°çš„è¿‡ç¨‹ä¸­ç”¨åˆ°äº† `cache` å¯¹è±¡ç”¨äºä¿å­˜ç¼“å­˜çš„ç»„ä»¶å®ä¾‹åŠ `key` å€¼ï¼Œ`keys` æ•°ç»„ç”¨äºä¿å­˜ç¼“å­˜ç»„ä»¶çš„ `key` ï¼Œå½“ `keep-alive` ä¸­æ¸²æŸ“ä¸€ä¸ªéœ€è¦ç¼“å­˜çš„å®ä¾‹æ—¶ï¼š

- åˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å·²ç¼“å­˜äº†è¯¥å®ä¾‹ï¼Œç¼“å­˜äº†åˆ™ç›´æ¥è·å–ï¼Œå¹¶è°ƒæ•´ `key` åœ¨ `keys` ä¸­çš„ä½ç½®ï¼ˆç§»é™¤ `keys` ä¸­ `key` ï¼Œå¹¶æ”¾å…¥ `keys` æ•°ç»„çš„æœ€åä¸€ä½ï¼‰
- å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™ç¼“å­˜è¯¥å®ä¾‹ï¼Œè‹¥ `keys` çš„é•¿åº¦å¤§äº `max` ï¼ˆç¼“å­˜é•¿åº¦è¶…è¿‡ä¸Šé™ï¼‰ï¼Œåˆ™ç§»é™¤ `keys[0]` ç¼“å­˜

ä¸‹é¢æˆ‘ä»¬æ¥è‡ªå·±å®ç°ä¸€ä¸ª LRU ç®—æ³•å§â›½ï¸â›½ï¸â›½ï¸

### ä¸‰ã€leetcodeï¼šLRU ç¼“å­˜æœºåˆ¶

è¿ç”¨ä½ æ‰€æŒæ¡çš„æ•°æ®ç»“æ„ï¼Œè®¾è®¡å’Œå®ç°ä¸€ä¸ª LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜æœºåˆ¶ã€‚å®ƒåº”è¯¥æ”¯æŒä»¥ä¸‹æ“ä½œï¼š è·å–æ•°æ® `get` å’Œå†™å…¥æ•°æ® `put` ã€‚

è·å–æ•°æ® `get(key)` - å¦‚æœå¯†é’¥ ( `key` ) å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è·å–å¯†é’¥çš„å€¼ï¼ˆæ€»æ˜¯æ­£æ•°ï¼‰ï¼Œå¦åˆ™è¿”å› `-1` ã€‚
å†™å…¥æ•°æ® `put(key, value)` - å¦‚æœå¯†é’¥ä¸å­˜åœ¨ï¼Œåˆ™å†™å…¥æ•°æ®ã€‚å½“ç¼“å­˜å®¹é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå®ƒåº”è¯¥åœ¨å†™å…¥æ–°æ•°æ®ä¹‹å‰åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®ï¼Œä»è€Œä¸ºæ–°æ•°æ®ç•™å‡ºç©ºé—´ã€‚

**è¿›é˜¶:**

ä½ æ˜¯å¦å¯ä»¥åœ¨ **O(1)** æ—¶é—´å¤æ‚åº¦å†…å®Œæˆè¿™ä¸¤ç§æ“ä½œï¼Ÿ

**ç¤ºä¾‹:**

```
LRUCache cache = new LRUCache( 2 /* ç¼“å­˜å®¹é‡ */ );

cache.put(1, 1);
cache.put(2, 2);
cache.get(1);       // è¿”å›  1
cache.put(3, 3);    // è¯¥æ“ä½œä¼šä½¿å¾—å¯†é’¥ 2 ä½œåºŸ
cache.get(2);       // è¿”å› -1 (æœªæ‰¾åˆ°)
cache.put(4, 4);    // è¯¥æ“ä½œä¼šä½¿å¾—å¯†é’¥ 1 ä½œåºŸ
cache.get(1);       // è¿”å› -1 (æœªæ‰¾åˆ°)
cache.get(3);       // è¿”å›  3
cache.get(4);       // è¿”å›  4
```

å‰é¢å·²ç»ä»‹ç»è¿‡äº† `keep-alive` ä¸­LRUå®ç°æºç ï¼Œç°åœ¨æ¥çœ‹è¿™é“é¢˜æ˜¯ä¸æ˜¯å¾ˆç®€å•ğŸ˜ŠğŸ˜ŠğŸ˜Šï¼Œå¯ä»¥å°è¯•è‡ªå·±è§£ç­”ä¸€ä¸‹â›½ï¸ï¼Œç„¶åæ€è€ƒä¸€ä¸‹æœ‰æ²¡æœ‰ä»€ä¹ˆç»§ç»­ä¼˜åŒ–çš„ï¼æ¬¢è¿æä¾›æ›´å¤šçš„è§£æ³•

```js
function LRU(max) {
  this.max = max;
  this.cache = new Map();
}

LRU.prototype = {
  get(key) {
    const { cache } = this,
      value = cache.get(key);
    if (!value) return;
    cache.delete(key);
    cache.set(key, value);
    return value;
  },
  add(key, value) {
    const { cache } = this;
    if (cache.size > this.max - 1) {
      const keys = cache.keys().next().value;
      cache.delete(keys);
    }
    cache.set(key, value);
  }
};

const lru = new LRU(4);
lru.add(1, 1);
lru.add(2, 2);
lru.add(3, 3);
lru.add(4, 4);
lru.get(2);
lru.get(2);
lru.get(2);
lru.add(5, 5);

console.log(lru.cache);
```

ç­”æ¡ˆå·²æäº¤åˆ° [#7](https://github.com/sisterAn/JavaScript-Algorithms/issues/7)

